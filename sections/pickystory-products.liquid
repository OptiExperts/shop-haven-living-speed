{% comment %}
Render multiple products to JSON.
The response is a <section> element containing a JSON string with an array of the requested
products. The list is limited to at most 20 products.
If you choose to uninstall PickyStory, this section can be safely deleted.
Get the app: https://go.pickystory.com/8nsjceym.
Contact us for any questions: hello@pickystory.com.
Copyright (C) 2022 Picky Story Ltd. - All Rights Reserved
{% endcomment %}

{% schema %}
  {
    "name": "PickyStory products",
    "tag": "section",
    "class": "pickystory-content-json",
    "limit": 1,
    "settings": []
  }
{% endschema %}

{%- assign page_url = content_for_header | split:'"pageurl":"' | last | split:'"' | first | split: request.host | last | replace:'\/','/' | replace:'%20',' ' | replace:'%2C',',' | replace:'\u0026','&'  -%}

[
{%  if page_url contains "?" %}
  {%- assign query_string = page_url | split:'?' | last -%}
  {%- assign query_parts= query_string | split:'&' -%}

  {%- for part in query_parts -%}
    {%- assign key_and_value = part | split:'=' -%}
    {%- if key_and_value.size > 1 -%}
      {% if key_and_value[0] == 'picky-products' %}
        {% assign product_handles = key_and_value[1] | split:',' %}
        {% assign product_count = 0 %}
        {% assign product_handles_size = product_handles | size %}
        {%- for handle in product_handles -%}
          {% comment %} Send only a subset of product fields {% endcomment %}
          {
            "id": {{ all_products[handle].id | json }},
            "handle": {{ all_products[handle].handle| json  }},
            "available": {{ all_products[handle].available | json }},
            "price": {{ all_products[handle].price | json }},
            "compareAtPrice": {{ all_products[handle].compare_at_price | json }},
            "variants": {{ all_products[handle].variants | json }},
            "featuredImage": {{ all_products[handle].featured_image | json }},
            "images": {{ all_products[handle].images | json }},
            "options": {{ all_products[handle].options | json }}
          }
          {% assign product_count = product_count | plus: 1 %}
          {% if product_count != product_handles_size %}
            ,
          {% endif %}
          {% if product_count >= 20 %}
            {% break %}
          {% endif %}
        {%- endfor -%}
        {% comment %} Do not process our query param more than once {% endcomment %}
        {% break %}
      {% endif %}
    {%- endif -%}
  {%- endfor -%}
{%- endif -%}
]
